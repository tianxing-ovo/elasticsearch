<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>黑马旅游</title>
    <link rel="icon" type="image/png" href="./img/heima.png">
    <link rel="stylesheet" href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css" />
    <link rel="stylesheet" href="./css/index.css" />
    <link rel="stylesheet" href="./css/banner.css" />
</head>

<body>
    <div id="app" @click="showOps=false">
        <div style="width: 70%;text-align: center;margin: auto;">
            <div class="banner">
                <div class="logo">
                    <img src="./img/heima.png" alt="1" />
                    <span>
                        <div class="logo-ch">黑马旅游</div>
                        <div class="logo-en">www.itheima.com</div>
                    </span>
                </div>
            </div>
            <!--关键字搜索-->
            <div class="search-bar">
                <div class="input-box">
                    <input title="输入关键字搜索酒店" v-model="params.key" type="text" @click.stop="" @focus="showOps=true"
                        @keyup="handleKeyUp($event)">
                    <button @click="handleSearch">搜索</button>
                </div>
                <div id="complete-box" v-show="showOps && ops.length > 0">
                    <div v-for="(item, i) in ops" :key="i" @click="handleSearch" @mouseover="opsIndex = i"
                        :style='{"background-color": opsIndex===i ? "#EEE" : "#fff"}'>{{item}}
                    </div>
                </div>
            </div>
            <!--已选择过滤项-->
            <div class="selected-ops">
                <div class="open">全部结果：</div>
                <div class="selected-op" v-for="(v, k) in params.filters" :key="k" @click="deleteFilter(k)">
                    {{filterNames[k]}}：<span>{{v}} <span class='close'>×</span></span>
                </div>
            </div>
            <!--过滤项-->
            <div class="filter-list">
                <div v-for="(v, k) in remainFilter" :key="k">
                    <div class="filter-box">
                        <div class="f-key"><strong>{{filterNames[k]}}</strong></div>
                        <div class="column-divider"></div>
                        <div class="f-items">
                            <div class="f-item" @click="clickFilter(k, o)" v-for="(o, j) in v" :key="j"><a
                                    href="javascript:void(0)">
                                    {{o}}</a></div>
                        </div>
                    </div>
                    <div class="row-divider"></div>
                </div>
                <div class="filter-box">
                    <div class="f-key"><strong>价格</strong></div>
                    <div class="column-divider"></div>
                    <div class="f-items">
                        <div class="f-item" @click="clickFilter('price','0-100')"><a
                                href="javascript:void(0)">100元以下</a>
                        </div>
                        <div class="f-item" @click="clickFilter('price','100-300')"><a
                                href="javascript:void(0)">100-300元</a></div>
                        <div class="f-item" @click="clickFilter('price','300-600')"><a
                                href="javascript:void(0)">300-600元</a></div>
                        <div class="f-item" @click="clickFilter('price','600-1500')"><a
                                href="javascript:void(0)">600-1500元</a>
                        </div>
                        <div class="f-item" @click="clickFilter('price','1500-0')"><a
                                href="javascript:void(0)">1500元以上</a></div>
                    </div>
                </div>
            </div>
            <!--排序-->
            <div class="top-ban">
                <!--排序条件-->
                <div class="sort-items">
                    <div class="sort-item" v-for="(item, i) in sortItems" :key="i">
                        <a :class="{selected: params.sortBy===item.key}" @click="toggleSort(item.key)"
                            href="javascript:void(0)">{{item.text}}
                            <span v-if="params.sortBy===item.key && item.key!=='default'">
                                {{params.sortOrder === 'asc' ? '↑' : '↓'}}
                            </span>
                        </a>
                        |
                    </div>
                </div>

                <!--分页条-->
                <div class="top-pagination">
                    <span>共 <i style="color: #222;">{{total}}</i> 家酒店</span>
                    <span><i style="color: red;">{{params.pageNumber}}</i>/{{totalPage}}</span>
                    <a class="btn-arrow" href="#" style="display: inline-block" @click="prePage">&lt;</a>
                    <a class="btn-arrow" href="#" style="display: inline-block" @click="nextPage">&gt;</a>
                </div>
            </div>
            <div class="row-divider" style="margin-bottom: 5px; width: 100%"></div>
            <!--酒店列表-->
            <div style="display: flex; justify-content: space-between;">

                <div class="hotel-list">
                    <div class="hotel-box" v-for="(hotel,i) in hotels" :key="i"
                        style="display: flex;justify-content: space-between;" @mouseover="handleMarkerFocus(hotel)">
                        <div class="ad-mark" v-if="hotel.isAd">
                            <img src="./img/ad.png" width="30" alt="广告" />
                        </div>
                        <div style="width: 0;"></div>
                        <div style="width: 25%"><img width="100%" :src="hotel.pic" alt="酒店图片" /></div>
                        <div class="hotel-info">
                            <div class="hotel-name" v-html="hotel.name">
                            </div>
                            <div class="star-name"> {{hotel.starName}}</div>
                            <div class="address">
                                位于 <span style="color: #BC8516;">{{hotel.business}}</span> 周边，{{hotel.address}}
                            </div>
                            <div class="order"> 1分钟前有人预订了该酒店</div>
                            <div v-if="hotel.distance" class="address">距离您 {{hotel.distance.toFixed(2)}} km</div>
                        </div>
                        <div style="text-align: left; width: 15%;">
                            <div>
                                <b style="color: #f60;">￥</b> <span id='hotel-price'>{{hotel.price}}</span> <span
                                    style="font-size: 0.2em; color: #999;">起</span>
                            </div>
                            <div class='btn'>立即预定</div>
                            <div>
                                <span class="hotel-score">{{hotel.score / 10}}分</span> /<span>5分</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div :class='{"map-box": true, "fixed-map": isFixed}' :style="{left: ml + 'px'}">
                    <div class="map-head">地图预览</div>
                    <div class="amap" id="container"></div>
                    <div class="map-geo" @click="getGeoLoc">
                        <img src="https://a.amap.com/jsapi/static/image/plugin/waite.png" v-show="loading" alt="定位中" />
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="./js/vue.js"></script>
    <script src="./js/axios.min.js"></script>
    <script src="./js/amap.min.js"></script>
    <script type="text/javascript"
        src="https://webapi.amap.com/maps?v=2.0&key=ddd292c88aa1bad9c04891a47724f40a"></script>


    <script>
        // 设置后台服务地址
        axios.defaults.baseURL = "http://localhost:8089";
        axios.defaults.timeout = 3000;

        let app = new Vue({
            el: "#app",
            data: {
                filterNames: {
                    brand: "品牌",
                    city: "城市",
                    starName: "星级",
                    price: "价格",
                },
                filterList: {},
                sortItems: [
                    {
                        key: "default",
                        text: "默认",
                    },
                    {
                        key: "score",
                        text: "评价",
                    },
                    {
                        key: "price",
                        text: "价格",
                    },
                    {
                        key: "distance",
                        text: "距离",
                    }
                ],
                hotels: [],
                total: 0,
                totalPage: 0,
                params: {
                    key: "",
                    pageNumber: 1,
                    pageSize: 5,
                    sortBy: "default",
                    sortOrder: "asc",
                    filters: {},
                },
                map: {},
                loc: "",
                ml: 0,
                geolocation: {},
                loading: false,
                currentHotel: {},
                ops: [],
                showOps: false,
                opsIndex: -1,
                isFixed: false,
            },
            watch: {
                "params.sortBy"() {
                    // 每当sortBy改变(搜索一下)
                    this.search(this.loc);
                },
                "params.sortOrder"() {
                    // 每当sortOrder改变(搜索一下)
                    this.search(this.loc);
                },
                "params.pageNumber"() {
                    // 每当pageNumber改变(搜索一下)
                    this.search(this.loc);
                },
                "params.filters": {
                    deep: true,
                    handler() {
                        this.search();
                        // 获取过滤项
                        this.getFilter();
                    }
                },
                opsIndex() {
                    if (this.opsIndex !== -1) {
                        this.params.key = this.ops[this.opsIndex]
                    }
                }
            },
            created() {
                // 尝试从缓存读取位置信息(1小时内有效)
                try {
                    const cached = JSON.parse(localStorage.getItem('userLocation'));
                    if (cached && Date.now() - cached.timestamp < 3600000) {
                        this.loc = cached.loc;
                        console.log('使用缓存位置:', this.loc);
                    } else {
                        console.log('缓存位置已过期或不存在');
                    }
                } catch (e) {
                    // 兼容旧格式或解析失败
                    localStorage.removeItem('userLocation');
                    console.log('缓存解析失败');
                }
                // 页面加载时先搜索一下(如果有缓存位置会带上)
                this.search();
                // 获取过滤项
                this.getFilter();
            },
            mounted() {
                //初始化地图
                this.map = new AMap.Map('container', {
                    resizeEnable: true,
                    zoom: 11,
                    center: [120.0, 32.0],
                });
                // 初始化定位系统
                AMap.plugin('AMap.Geolocation', () => {
                    this.geolocation = new AMap.Geolocation({
                        position: 'RT',
                        buttonOffset: new AMap.Pixel(10, 20),
                        zoomToAccuracy: true,
                    });
                    // 返回定位信息
                    this.geolocation.on('complete', result => {
                        this.loc = result.position.lat + ", " + result.position.lng;
                        console.log('定位成功:', this.loc);
                        // 缓存位置信息(带时间戳)
                        localStorage.setItem('userLocation', JSON.stringify({
                            loc: this.loc,
                            timestamp: Date.now()
                        }));
                        // 定位成功后重新搜索以获取距离信息
                        this.searchByMap(this.loc);
                    });
                    // 返回定位出错信息
                    this.geolocation.on('error', err => console.log('定位失败:', err));
                    // 只在没有缓存位置时才自动定位
                    if (!this.loc) {
                        this.geolocation.getCurrentPosition();
                    }
                });
                let oDiv = document.querySelector(".map-box"),
                    H = 0,
                    Y = oDiv;
                while (Y) {
                    H += Y.offsetTop;
                    Y = Y.offsetParent;
                }
                window.addEventListener('scroll', () => this.handleScroll(H, oDiv));
            },
            methods: {
                handleScroll(h, o) {
                    let s = document.body.scrollTop || document.documentElement.scrollTop
                    this.isFixed = s > h;
                    this.ml = o.offsetLeft;
                },
                handleKeyUp(e) {
                    if ((e.keyCode >= 48 && e.keyCode <= 57) || (e.keyCode >= 65 && e.keyCode <= 90) || e.keyCode === 8) {
                        this.getSuggestion();
                    } else if (e.keyCode === 13) {
                        this.search();
                        this.getFilter();
                    } else if (e.keyCode === 38) {
                        if (this.opsIndex > 0) {
                            this.opsIndex--;
                        } else {
                            this.opsIndex = this.ops.length - 1;
                        }
                    } else if (e.keyCode === 40) {
                        this.opsIndex = (this.opsIndex + 1) % this.ops.length;
                    } else if (e.keyCode === 27) {
                        this.show = false
                    }
                },
                handleSearch() {
                    this.search();
                    this.getFilter();
                },
                toggleSort(key) {
                    if (this.params.sortBy === key && key !== 'default') {
                        // 点击已选中的排序项(切换升降序)
                        this.params.sortOrder = this.params.sortOrder === 'asc' ? 'desc' : 'asc';
                    } else {
                        // 点击新的排序项(默认升序)
                        this.params.sortBy = key;
                        this.params.sortOrder = 'asc';
                    }
                    // 如果选择距离排序且没有位置信息则自动定位
                    if (key === 'distance' && !this.loc) {
                        this.getCurrentLocation();
                    }
                },
                // 获取当前位置
                getCurrentLocation() {
                    if (this.geolocation && this.geolocation.getCurrentPosition) {
                        this.loading = true;
                        this.geolocation.getCurrentPosition((status, result) => {
                            this.loading = false;
                            if (status === 'complete') {
                                this.loc = result.position.lat + ", " + result.position.lng;
                                // 更新缓存
                                localStorage.setItem('userLocation', JSON.stringify({
                                    loc: this.loc,
                                    timestamp: Date.now()
                                }));
                                this.searchByMap(this.loc);
                            } else {
                                alert('定位失败，请点击地图选择位置');
                            }
                        });
                    }
                },
                getSuggestion() {
                    if (!this.params.key) {
                        this.ops = [];
                        return;
                    }
                    axios.get("/hotel/suggestion?key=" + this.params.key)
                        .then(resp => {
                            this.ops = resp.data;
                        })
                        .catch(e => {
                            this.ops = [];
                            console.log(e);
                        })
                },
                getFilter() {
                    // 准备参数
                    const { filters: { price: ps, ...fs }, ...params } = this.params;
                    for (const _k in fs) {
                        params[_k] = fs[_k];
                    }
                    // 处理价格
                    if (ps) {
                        let pArr = ps.split("-");
                        params.minPrice = parseInt(pArr[0]);
                        let max = parseInt(pArr[1]);
                        params.maxPrice = max === 0 ? 999999 : max;
                    }
                    axios.post("/hotel/filters", params)
                        .then(resp => {
                            this.filterList = resp.data;
                        })
                        .catch(err => {
                            console.log(err);
                        })
                },
                searchByMap(location) {
                    // 准备参数
                    const { filters: { price: ps, ...fs }, ...params } = this.params;
                    for (const _k in fs) {
                        params[_k] = fs[_k];
                    }
                    // 处理价格
                    if (ps) {
                        let pArr = ps.split("-");
                        params.minPrice = parseInt(pArr[0]);
                        let max = parseInt(pArr[1]);
                        params.maxPrice = max === 0 ? 999999 : max;
                    }
                    // 始终带上位置参数(优先使用传入的location，否则使用缓存的this.loc)
                    const loc = location || this.loc;
                    if (loc) {
                        params.location = loc;
                        this.loc = loc;
                    }
                    console.log('搜索请求参数:', JSON.stringify(params));
                    axios.post("/hotel/list", params)
                        .then(resp => {
                            this.hotels = resp.data.hotels;
                            this.total = resp.data.total;
                            this.totalPage = Math.ceil(this.total / this.params.pageSize);
                            if (loc) {
                                this.setMapCenter(loc);
                            } else if (this.hotels && this.hotels.length > 0) {
                                this.setMapCenter(this.hotels[0].location);
                            }
                            this.initMarker();
                        })
                        .catch(err => {
                            console.log(err);
                            this.hotels = [];
                            this.total = 0;
                            this.totalPage = 0;
                        })
                },
                search(location) {
                    // 如果没有传入位置则使用缓存的位置
                    this.searchByMap(location || this.loc);
                },
                prePage() {
                    if (this.params.pageNumber > 1) {
                        this.params.pageNumber--
                    }
                },
                nextPage() {
                    if (this.params.pageNumber < this.totalPage) {
                        this.params.pageNumber++
                    }
                },
                clickFilter(key, option) {
                    // 重置页码为1
                    this.params.pageNumber = 1;
                    const { ...obj } = this.params.filters;
                    obj[key] = option;
                    this.params.filters = obj;
                },
                deleteFilter(k) {
                    // 重置页码为1
                    this.params.pageNumber = 1;
                    const { ...obj } = this.params.filters;
                    delete obj[k];
                    this.params.filters = obj;
                },
                location(loc) {
                    let arr = loc.split(", ");
                    let json = '[' + arr[1] + ', ' + arr[0] + ']'
                    return JSON.parse(json);
                },
                initMarker() {
                    if (!this.loc) {
                        this.map.clearMap();
                    }
                    this.markHotels();
                },
                setMapCenter(location) {
                    this.map.setCenter(this.location(location));
                },
                markHotels() {
                    this.hotels.forEach((h, i) => {
                        // 将创建的点标记添加到已有的地图实例
                        let marker = new AMap.Marker({
                            position: this.location(h.location),
                            title: h.name,
                            offset: new AMap.Pixel(0, 0),
                            anchor: 'bottom-center'
                        });
                        marker.vid = h.id;
                        this.map.add(marker);
                    });
                },
                handleMarkerFocus(h) {
                    this.map.setCenter(this.location(h.location));
                    let old = this.currentHotel;
                    let oldMarker = this.map.getAllOverlays("marker").find(m => m.vid === old.id);
                    if (oldMarker) {
                        this.updateMarker(oldMarker, "//a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-default.png", "", this.location(old.location), old.id);
                    }

                    this.currentHotel = h;
                    let marker = this.map.getAllOverlays("marker").find(m => m.vid === h.id);
                    this.updateMarker(marker, "//a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-red.png", h.name, this.location(h.location), h.id);
                },
                updateMarker(marker, icon, text, position, id) {
                    // 自定义点标记内容
                    const markerContent = document.createElement("div");
                    // 点标记中的图标
                    const markerImg = document.createElement("img");
                    markerImg.className = "markerlnglat";
                    markerImg.src = icon;
                    markerImg.setAttribute('width', '25px');
                    markerImg.setAttribute('height', '34px');
                    markerContent.appendChild(markerImg);
                    // 点标记中的文本
                    if (text) {
                        const markerSpan = document.createElement("span");
                        markerSpan.className = 'marker';
                        markerSpan.innerHTML = text;
                        markerContent.appendChild(markerSpan);
                    }
                    marker.setContent(markerContent);
                    marker.setPosition(position);
                    marker.vid = id;
                },
                getGeoLoc() {
                    this.loading = true;
                    this.geolocation.getCurrentPosition((status, result) => {
                        this.loading = false;
                        if (status === 'complete') {
                            console.log('手动定位成功');
                            this.loc = result.position.lat + ", " + result.position.lng;
                            // 更新缓存
                            localStorage.setItem('userLocation', JSON.stringify({
                                loc: this.loc,
                                timestamp: Date.now()
                            }));
                            // 添加定位标记
                            this.addMaker('//a.amap.com/jsapi/static/image/plugin/point.png', result.position.lng, result.position.lat);
                            // 重置页码并搜索
                            this.params.pageNumber = 1;
                            this.searchByMap(this.loc);
                        } else {
                            console.log('手动定位失败:', status);
                            alert('定位失败，请检查定位权限');
                        }
                    });
                },
                addMaker(iconUrl, lng, lat) {
                    // 创建AMap.Icon实例
                    let icon = new AMap.Icon({
                        size: new AMap.Size(25, 25),
                        image: iconUrl,
                        imageOffset: new AMap.Pixel(0, 0),
                        imageSize: new AMap.Size(25, 25)
                    });
                    // 将Icon实例添加到marker上
                    let marker = new AMap.Marker({
                        position: new AMap.LngLat(lng, lat),
                        offset: new AMap.Pixel(0, 0),
                        icon: icon,
                        title: '北京',
                        zoom: 13,
                        anchor: "center"
                    });
                    this.map.add(marker);
                }
            },
            computed: {
                remainFilter() {
                    let keys = Object.keys(this.params.filters);
                    let obj = {};
                    Object.keys(this.filterList).forEach(key => {
                        if (!keys.includes(key) && this.filterList[key].length > 1) {
                            obj[key] = this.filterList[key];
                        }
                    })
                    return obj;
                }
            }
        })
    </script>
</body>

</html>